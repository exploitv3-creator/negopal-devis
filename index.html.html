<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEGOPAL ‚Äî Nouveau Devis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0F1117;
            --card: #181B24;
            --card-hover: #1E2230;
            --border: #2A2E3B;
            --accent: #F97316;
            --accent-hover: #FB923C;
            --accent-glow: rgba(249, 115, 22, 0.15);
            --text: #F1F2F4;
            --text-muted: #8B8FA3;
            --text-dim: #5C6070;
            --success: #22C55E;
            --danger: #EF4444;
            --input-bg: #12141C;
            --radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 0 30px;
        }

        .header .logo {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: -1px;
        }

        .header .logo span {
            color: var(--text);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-top: 8px;
            color: var(--text-muted);
        }

        .header .divider {
            width: 60px;
            height: 3px;
            background: var(--accent);
            margin: 16px auto 0;
            border-radius: 2px;
        }

        /* Sections */
        .section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title .icon {
            font-size: 16px;
        }

        /* Form grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .form-grid .full {
            grid-column: 1 / -1;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group label .required {
            color: var(--accent);
        }

        input, select {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            color: var(--text);
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
            outline: none;
        }

        input:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        input::placeholder {
            color: var(--text-dim);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238B8FA3' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
        }

        select option {
            background: var(--card);
            color: var(--text);
        }

        /* Lignes devis */
        .ligne-devis {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 10px;
            position: relative;
            transition: border-color 0.2s;
        }

        .ligne-devis:hover {
            border-color: var(--accent);
        }

        .ligne-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ligne-number {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent);
            background: var(--accent-glow);
            padding: 3px 10px;
            border-radius: 20px;
        }

        .btn-remove {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-remove:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .ligne-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
        }

        .btn-add-ligne {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            color: var(--text-muted);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 4px;
        }

        .btn-add-ligne:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        /* Total */
        .total-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .total-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .total-value {
            font-family: 'Space Mono', monospace;
            font-size: 22px;
            font-weight: 700;
            color: var(--accent);
        }

        /* Submit */
        .btn-submit {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            border: none;
            border-radius: var(--radius);
            color: #fff;
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        .btn-submit:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(249, 115, 22, 0.3);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Success message */
        .success-message {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .success-message .checkmark {
            width: 64px;
            height: 64px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
        }

        .success-message h2 {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .success-message p {
            color: var(--text-muted);
            font-size: 15px;
        }

        .btn-new {
            margin-top: 24px;
            padding: 12px 28px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-new:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Responsive */
        @media (max-width: 600px) {
            body { padding: 12px; }
            .section { padding: 20px; }
            .form-grid { grid-template-columns: 1fr; }
            .ligne-grid { grid-template-columns: 1fr; }
            .header .logo { font-size: 24px; }
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">NEGO<span>PAL</span></div>
            <h1>Nouveau Devis</h1>
            <div class="divider"></div>
        </div>

        <!-- Form -->
        <form id="devisForm">
            <!-- Section Client -->
            <div class="section">
                <div class="section-title">
                    <span class="icon">üë§</span> Informations client
                </div>
                <div class="form-grid">
                    <div class="form-group full">
                        <label>Nom de l'entreprise <span class="required">*</span></label>
                        <input type="text" name="nom_entreprise" required placeholder="Ex: ACME SAS">
                    </div>
                    <div class="form-group">
                        <label>Contact</label>
                        <input type="text" name="contact" placeholder="Nom du contact">
                    </div>
                    <div class="form-group">
                        <label>Email <span class="required">*</span></label>
                        <input type="email" name="email" required placeholder="email@entreprise.com">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" name="telephone" placeholder="06 12 34 56 78">
                    </div>
                    <div class="form-group">
                        <label>SIRET</label>
                        <input type="text" name="siret" placeholder="123 456 789 00001">
                    </div>
                    <div class="form-group full">
                        <label>Adresse</label>
                        <input type="text" name="adresse" placeholder="Num√©ro et rue">
                    </div>
                    <div class="form-group">
                        <label>Ville</label>
                        <input type="text" name="ville" placeholder="Lyon">
                    </div>
                    <div class="form-group">
                        <label>Code postal</label>
                        <input type="text" name="code_postal" placeholder="69000">
                    </div>
                    <div class="form-group">
                        <label>Pays</label>
                        <select name="pays">
                            <option value="FR">France</option>
                            <option value="BE">Belgique</option>
                            <option value="CH">Suisse</option>
                            <option value="DE">Allemagne</option>
                            <option value="IT">Italie</option>
                            <option value="ES">Espagne</option>
                            <option value="NL">Pays-Bas</option>
                            <option value="LU">Luxembourg</option>
                            <option value="GB">Royaume-Uni</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section Lignes Devis -->
            <div class="section">
                <div class="section-title">
                    <span class="icon">üì¶</span> Lignes du devis
                </div>

                <div id="lignesContainer">
                    <!-- Ligne 1 g√©n√©r√©e par JS -->
                </div>

                <button type="button" class="btn-add-ligne" onclick="addLigne()">
                    + Ajouter une ligne
                </button>

                <div class="total-bar">
                    <span class="total-label">Total HT estim√©</span>
                    <span class="total-value" id="totalHT">0,00 ‚Ç¨</span>
                </div>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn-submit" id="submitBtn">
                Cr√©er le devis
            </button>
        </form>

        <!-- Success -->
        <div class="success-message" id="successMessage">
            <div class="checkmark">‚úì</div>
            <h2>Devis cr√©√© avec succ√®s !</h2>
            <p>Le devis a √©t√© envoy√© pour traitement.</p>
            <button class="btn-new" onclick="resetForm()">Cr√©er un nouveau devis</button>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION ‚Äî Remplace cette URL par ton webhook n8n
        // ============================================================
        const WEBHOOK_URL = 'https://melma2.app.n8n.cloud/webhook/705547fd-b6d8-4864-8900-af762b8ec6dd';

        // Types de palettes NEGOPAL
        const TYPES_PALETTES = [
            'Europe neuve NIMP15',
            'Europe occasion 1er choix',
            'Europe occasion 2√®me choix',
            'Europe occasion 3√®me choix',
            'Europe cass√©e',
            'Europe l√©g√®re 1er choix',
            'Europe l√©g√®re 2√®me choix',
            'Europe l√©g√®re cass√©e',
            'Demi-palette 80√ó60 1er choix',
            'Demi-palette 80√ó60 2√®me choix',
            'Demi-palette 80√ó60 3√®me choix NIMP15',
            'Demi-palette 80√ó60 cass√©e',
            'Quart de palette 60√ó40',
            'Palette chimique CP1',
            'Palette chimique CP3',
            'Palette chimique CP9',
            'Palette 80√ó120 l√©g√®re',
            'Palette 80√ó120 lourde',
            'Palette 100√ó120 l√©g√®re',
            'Palette 100√ó120 lourde',
            'Palette 80√ó120 2 entr√©es',
            'Palette 114√ó114',
            'Palette hors cote',
            'Rondin',
            'Bois de chauffe',
            'Plot / D√©'
        ];

        let ligneCount = 0;

        function createSelectOptions() {
            let options = '<option value="">S√©lectionner...</option>';
            TYPES_PALETTES.forEach(type => {
                options += `<option value="${type}">${type}</option>`;
            });
            return options;
        }

        function addLigne() {
            ligneCount++;
            const container = document.getElementById('lignesContainer');
            const ligne = document.createElement('div');
            ligne.className = 'ligne-devis';
            ligne.id = `ligne-${ligneCount}`;
            ligne.innerHTML = `
                <div class="ligne-header">
                    <span class="ligne-number">Ligne ${ligneCount}</span>
                    ${ligneCount > 1 ? `<button type="button" class="btn-remove" onclick="removeLigne(${ligneCount})">‚úï</button>` : ''}
                </div>
                <div class="ligne-grid">
                    <div class="form-group">
                        <label>Type palette <span class="required">*</span></label>
                        <select name="type_palette_${ligneCount}" required>
                            ${createSelectOptions()}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantit√© <span class="required">*</span></label>
                        <input type="number" name="quantite_${ligneCount}" required min="1" placeholder="0" oninput="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>Prix unit. HT <span class="required">*</span></label>
                        <input type="number" name="prix_${ligneCount}" required min="0" step="0.01" placeholder="0.00" oninput="updateTotal()">
                    </div>
                </div>
            `;
            container.appendChild(ligne);
        }

        function removeLigne(id) {
            const ligne = document.getElementById(`ligne-${id}`);
            if (ligne) {
                ligne.remove();
                updateTotal();
            }
        }

        function updateTotal() {
            let total = 0;
            const lignes = document.querySelectorAll('.ligne-devis');
            lignes.forEach(ligne => {
                const qte = ligne.querySelector('input[name^="quantite"]');
                const prix = ligne.querySelector('input[name^="prix"]');
                if (qte && prix && qte.value && prix.value) {
                    total += parseFloat(qte.value) * parseFloat(prix.value);
                }
            });
            document.getElementById('totalHT').textContent = 
                total.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
        }

        function collectFormData() {
            const form = document.getElementById('devisForm');
            const formData = new FormData(form);

            // Client
            const client = {
                nom_entreprise: formData.get('nom_entreprise'),
                contact: formData.get('contact'),
                email: formData.get('email'),
                telephone: formData.get('telephone'),
                siret: formData.get('siret'),
                adresse: formData.get('adresse'),
                ville: formData.get('ville'),
                code_postal: formData.get('code_postal'),
                pays: formData.get('pays')
            };

            // Lignes
            const lignes = [];
            const lignesDOM = document.querySelectorAll('.ligne-devis');
            lignesDOM.forEach(ligne => {
                const type = ligne.querySelector('select[name^="type_palette"]').value;
                const qte = ligne.querySelector('input[name^="quantite"]').value;
                const prix = ligne.querySelector('input[name^="prix"]').value;
                if (type && qte && prix) {
                    lignes.push({
                        type_palette: type,
                        quantite: parseInt(qte),
                        prix_unitaire_ht: parseFloat(prix),
                        total_ligne: parseInt(qte) * parseFloat(prix)
                    });
                }
            });

            return {
                client,
                lignes,
                total_ht: lignes.reduce((sum, l) => sum + l.total_ligne, 0),
                date: new Date().toISOString(),
                source: 'formulaire_negopal'
            };
        }

        // Submit
        document.getElementById('devisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Envoi en cours...';

            const data = collectFormData();

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('devisForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                } else {
                    throw new Error('Erreur serveur');
                }
            } catch (err) {
                alert('Erreur lors de l\'envoi. V√©rifiez votre connexion et r√©essayez.');
                btn.disabled = false;
                btn.innerHTML = 'Cr√©er le devis';
            }
        });

        function resetForm() {
            document.getElementById('devisForm').reset();
            document.getElementById('lignesContainer').innerHTML = '';
            ligneCount = 0;
            addLigne();
            document.getElementById('totalHT').textContent = '0,00 ‚Ç¨';
            document.getElementById('devisForm').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Init
        addLigne();
    </script>
</body>
</html>
